<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>å‹•ç”»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ & ãƒ¡ã‚¿è¡¨ç¤º</title>

<style>
:root { color-scheme: light dark; }
body{font-family:sans-serif;margin:0;padding-top:50px;background:#f0f0f5;color:#333}
@media(prefers-color-scheme:dark){
  body{background:#121212;color:#eee}
  header{background:#222}
  .input-container input,.input-container button{background:#333;color:#eee;border-color:#444}
}
header{position:fixed;top:0;width:100%;background:#007bff;display:flex;flex-direction:column;z-index:1000}
.input-container{display:flex;padding:8px;max-width:800px;margin:0 auto;width:100%}
.input-container input{flex:1;padding:10px;font-size:16px;border:1px solid #ccc;border-radius:4px 0 0 4px}
.input-container button{padding:10px 16px;font-size:16px;border:none;border-radius:0 4px 4px 0;cursor:pointer;background:#0056b3;color:#fff}
#progressContainer{height:3px;background:#ccc;width:100%}
#progressBar{height:100%;width:0%;background:#28a745;transition:width .3s ease}
#log{position:fixed;top:55px;right:0;width:300px;max-height:90vh;background:rgba(0,0,0,.8);color:#fff;font-size:13px;
      padding:10px;overflow-y:auto;display:none;z-index:1001}
#result,#videoLink,#videoInfo{max-width:800px;margin:1em auto;text-align:center}
video{margin-top:20px;width:100%;max-width:720px}
.button-link{display:inline-block;margin-top:10px;background:#2196f3;color:#fff;padding:.5em 1em;border-radius:4px;text-decoration:none}

/* ---------- æƒ…å ±è¡¨ç¤º ---------- */
.info-title{font-size:20px;font-weight:700;margin:.5em 0}
.info-meta{font-size:14px;color:#666;margin-bottom:.3em}
body.dark .info-meta{color:#aaa}
.info-desc{white-space:pre-wrap;font-size:14px;margin-top:.5em}
#descToggle{color:#2196f3;cursor:pointer;font-size:14px;margin-top:.2em}
.comment{border-bottom:1px solid #ddd;padding:.7em 0;font-size:14px;text-align:left}
.comment:last-child{border:none}
body.dark .comment{border-color:#333}
.comment-author{font-weight:600;margin-bottom:.2em}
.comment-likes{font-size:12px;color:#999}
body.dark .comment-likes{color:#777}
</style>
</head>

<body>
<header>
  <div class="input-container">
    <input type="text" id="url" placeholder="YouTube ã® URL ã‚’å…¥åŠ›">
    <button onclick="download()" id="downloadBtn">å–å¾—</button>
    <button onclick="toggleLog()" id="toggleLogBtn">ãƒ­ã‚°</button>
  </div>
  <div id="progressContainer"><div id="progressBar"></div></div>
</header>

<div id="log"></div>
<div id="result"></div>
<div id="videoLink"></div>
<div id="videoInfo"></div>

<script>
/* ----------- è¨­å®š ----------- */
const SERVER      = location.origin;               // åŒä¸€ãƒ›ã‚¹ãƒˆã§å‹•ã‹ã™æƒ³å®š
const API_DL      = SERVER + '/download';
const API_INFO    = SERVER + '/info';
const WS_URL      = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host;
let   inProgress  = false;
let   logVisible  = false;

/* ----------- å…±é€š ---------- */
function extractVideoId(url){
  const m = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/);
  return m ? m[1] : null;
}
function toggleLog(){
  logVisible = !logVisible;
  document.getElementById('log').style.display = logVisible ? 'block':'none';
  document.getElementById('toggleLogBtn').textContent = logVisible ? 'éè¡¨ç¤º' : 'ãƒ­ã‚°';
}

/* =================================================
   ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ + ãƒ¡ã‚¿æƒ…å ±å–å¾—
   ================================================= */
function download(){
  if(inProgress){ alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­ã§ã™'); return; }

  const url = document.getElementById('url').value.trim();
  const id  = extractVideoId(url);
  if(!id){ alert('æ­£ã—ã„ URL ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  inProgress = true;
  const btn  = document.getElementById('downloadBtn');
  btn.disabled = true; btn.textContent = 'å–å¾—ä¸­â€¦';
  document.getElementById('progressBar').style.width = '0%';
  document.getElementById('progressContainer').style.display = 'block';
  document.getElementById('log').textContent = '';
  document.getElementById('result').innerHTML = '';
  document.getElementById('videoLink').innerHTML = '';
  document.getElementById('videoInfo').innerHTML = '';

  /* ---------- WebSocket ã§é€²æ— ---------- */
  const ws = new WebSocket(WS_URL);
  ws.onopen = () => ws.send(JSON.stringify({ id })) ;
  ws.onmessage = ev => {
    const msg = JSON.parse(ev.data);
    if(msg.progress){
      document.getElementById('log').textContent += msg.progress;
      const m = msg.progress.match(/(\d{1,3}\.\d)%/);
      if(m){ document.getElementById('progressBar').style.width = Math.min(+m[1],100)+'%'; }
    }
    if(msg.done){
      ws.close();
      finishDownload(msg, id);
    }
  };

  /* ---------- REST: /download ---------- */
  fetch(API_DL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({url}) })
    .then(r=>r.json())
    .then(d=>{ if(!d.success) alert('DL ã‚¨ãƒ©ãƒ¼'); })
    .catch(err=> console.error(err));

  /* ---------- å…ˆã«ãƒ¡ã‚¿æƒ…å ±ã‚‚å–å¾— ---------- */
  fetch(API_INFO, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({url}) })
    .then(r=>r.json())
    .then(d=>{ if(d.success) renderInfo(d.info); })
    .catch(console.error);
}

/* ---------- DL çµ‚äº†å¾Œ ---------- */
function finishDownload(msg, id){
  inProgress = false;
  const btn = document.getElementById('downloadBtn');
  btn.disabled = false; btn.textContent = 'å–å¾—';
  document.getElementById('progressContainer').style.display = 'none';

  if(msg.success){
    const videoUrl = SERVER + msg.videoUrl + '?t=' + Date.now();
    document.getElementById('result').innerHTML =
      `<video controls><source src="${videoUrl}" type="video/mp4"></video>`;
    document.getElementById('videoLink').innerHTML =
      `<a href="${videoUrl}" class="button-link" target="_blank">å‹•ç”»ãƒªãƒ³ã‚¯ã‚’é–‹ã</a>`;
  }else{
    document.getElementById('result').textContent = 'å‹•ç”»å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
  }
}

/* =================================================
   ãƒ¡ã‚¿æƒ…å ±ã®æç”»
   ================================================= */
function renderInfo(info){
  /* ---------- æ¦‚è¦æ¬„ã®æŠ˜ã‚ŠãŸãŸã¿ ---------- */
  const shortDesc = info.description.slice(0,150);
  const isLong    = info.description.length > 150;

  const html = `
    <div class="info-title">${info.title}</div>
    <div class="info-meta">
      è¦–è´å›æ•° ${info.view_count.toLocaleString()} å›ã€€
      æŠ•ç¨¿æ—¥ ${formatDate(info.upload_date)}ã€€
      ğŸ‘ ${info.like_count?.toLocaleString() ?? '-'}
    </div>
    <div class="info-meta">
      ãƒãƒ£ãƒ³ãƒãƒ«: <a href="${info.channel_url}" target="_blank">${info.uploader}</a>
      ï¼ˆç™»éŒ²è€… ${info.subscriber_count?.toLocaleString() ?? '-'} äººï¼‰
    </div>
    <div class="info-desc" id="description">${isLong ? shortDesc : info.description}</div>
    ${isLong ? '<div id="descToggle">ã‚‚ã£ã¨è¦‹ã‚‹</div>' : ''}
    <hr>
    <div style="text-align:left;font-weight:600;margin:.4em 0">ã‚³ãƒ¡ãƒ³ãƒˆ</div>
    ${renderComments(info.comments)}
  `;
  document.getElementById('videoInfo').innerHTML = html;

  if(isLong){
    document.getElementById('descToggle').onclick = () => {
      const desc = document.getElementById('description');
      const toggle = document.getElementById('descToggle');
      if(toggle.textContent === 'ã‚‚ã£ã¨è¦‹ã‚‹'){
        desc.textContent = info.description;
        toggle.textContent = 'é–‰ã˜ã‚‹';
      }else{
        desc.textContent = shortDesc;
        toggle.textContent = 'ã‚‚ã£ã¨è¦‹ã‚‹';
      }
    };
  }
}

function formatDate(yyyymmdd){
  return `${yyyymmdd.slice(0,4)}-${yyyymmdd.slice(4,6)}-${yyyymmdd.slice(6)}`;
}
function renderComments(comments=[]){
  if(!comments.length) return '<div>ã‚³ãƒ¡ãƒ³ãƒˆã¯å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>';
  return comments.map(c=>`
    <div class="comment">
      <div class="comment-author">${c.author}</div>
      <div>${c.text}</div>
      <div class="comment-likes">ğŸ‘ ${c.likes.toLocaleString()}ã€€${c.published}</div>
    </div>`).join('');
}
</script>
</body>
</html>
